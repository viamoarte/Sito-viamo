<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Scopri le opere uniche di ViAmo, artista di street art e pop culture.">
    <meta name="keywords" content="ViAmo, Vincenza Amodio, arte, galleria, street art">
    <meta name="author" content="ViAmo Art">
    <title>ViAmo - Galleria d'Arte</title>
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        (function(){
            emailjs.init("z2kCGkszIchfP51G_");
        })();
    </script>
    <style>
        body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f0f0f0;}
        header{background:#2c3e50;color:#fff;padding:15px;text-align:center;position:relative;}
        #banner{width:100%;max-height:350px;object-fit:cover;display:block;}
        nav{background:#34495e;padding:10px;text-align:center;}
        nav a{color:#fff;margin:0 15px;text-decoration:none;font-size:1.1em;}
        nav a:hover{text-decoration:underline;}
        section{padding:25px;margin:20px;background:#fff;border-radius:10px;box-shadow:0 0 15px rgba(0,0,0,.1);}
        .gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;max-height:70vh;overflow-y:auto;padding:10px;}
        .artwork{border:1px solid #ddd;padding:15px;text-align:center;background:#fff;border-radius:8px;}
        .artwork img{width:100%;height:200px;object-fit:cover;border-radius:5px;}
        .artwork a,.artwork button{display:inline-block;margin:8px 4px 0;padding:8px 14px;background:#2c3e50;color:#fff;text-decoration:none;border:none;border-radius:5px;font-size:.9em;cursor:pointer;}
        .artwork a:hover,.artwork button:hover{background:#34495e;}
        form{display:flex;flex-direction:column;max-width:450px;margin:0 auto;}
        input,textarea{margin:10px 0;padding:12px;border:1px solid #ccc;border-radius:5px;font-size:1em;}
        input[type=file]{margin:10px 0;padding:8px;}
        button{background:#2c3e50;color:#fff;border:none;padding:12px;border-radius:5px;cursor:pointer;font-size:1em;}
        button:hover{background:#34495e;}
        #admin{display:none;}
        .error{color:red;display:none;text-align:center;margin:10px 0;}
        .feedback{padding:10px;border-radius:5px;margin:10px 0;text-align:center;}
        .feedback.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb;}
        .feedback.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;}
        .preview-img{max-width:100%;max-height:150px;margin:10px 0;border-radius:5px;display:none;}
        .password-change{background:#f9f9f9;padding:15px;border-radius:8px;margin-top:20px;}
        .admin-section{margin-bottom:30px;}
        .admin-section h3{margin-top:0;}
        .github-sync{margin:10px 0;font-size:0.9em;}
        .github-sync span{color:green;font-weight:bold;}
        .warning{color:#d35400;font-weight:bold;}
        @media (max-width:600px){nav a{display:block;margin:10px 0;}.gallery{grid-template-columns:1fr;}}
    </style>
</head>
<body>
    <header>
        <img id="banner" src="Opere/banner.jpg" alt="Banner ViAmo" loading="lazy">
        <h1>ViAmo - Vincenza Amodio</h1>
    </header>
    <nav aria-label="Navigazione principale">
        <a href="#home">Home</a>
        <a href="#gallery">Galleria</a>
        <a href="#about">Chi Sono</a>
        <a href="#contact">Contatti</a>
        <a href="#" onclick="toggleAdmin()">Area Riservata</a>
    </nav>
    <section id="home"><h2>Home</h2><p id="home-text">Caricamento...</p></section>
    <section id="gallery"><h2>Galleria Opere</h2><div class="gallery" id="gallery-container"></div></section>
    <section id="about"><h2>Chi è ViAmo</h2><p id="about-text">Caricamento...</p></section>
    <!-- FORM CONTATTAMI -->
    <section id="contact">
        <h2>Contattami</h2>
        <form id="contact-form">
            <input type="text" name="user_name" id="user_name" placeholder="Il tuo nome" required>
            <input type="email" name="user_email" id="user_email" placeholder="La tua email" required>
            <textarea name="message" id="message" placeholder="Il tuo messaggio" rows="5" required></textarea>
            <button type="submit">Invia Messaggio</button>
            <div id="form-feedback"></div>
        </form>
    </section>
    <!-- AREA ADMIN -->
    <section id="admin">
        <h2>Area Amministratore</h2>
        <div class="error" id="admin-error">Errore: controlla la console.</div>
       
        <div id="login-section">
            <form id="login-form">
                <input type="password" id="admin-password" placeholder="Password Admin" required>
                <div class="error" id="login-error">Password errata.</div>
                <button type="submit">Accedi</button>
            </form>
        </div>
        <div id="admin-panel" style="display:none;">
            <button onclick="logout()">Esci</button>
            <button onclick="forceSyncFromGitHub()" style="background:#9b59b6;margin-left:10px;">Forza Sync GitHub</button>
            <!-- BANNER -->
            <div class="admin-section">
                <h3>Modifica Banner</h3>
                <form id="banner-form">
                    <input type="file" id="banner-file" accept="image/*">
                    <img id="banner-preview" class="preview-img" alt="Anteprima">
                    <button type="submit">Aggiorna</button>
                    <div id="banner-feedback"></div>
                </form>
            </div>
            <!-- TESTI -->
            <div class="admin-section">
                <h3>Testo Home</h3>
                <form id="home-form">
                    <textarea id="new-home-text" rows="4" required></textarea>
                    <button type="submit">Aggiorna</button>
                </form>
            </div>
            <div class="admin-section">
                <h3>Testo Chi è ViAmo</h3>
                <form id="about-form">
                    <textarea id="new-about-text" rows="4" required></textarea>
                    <button type="submit">Aggiorna</button>
                </form>
            </div>
            <!-- OPERE -->
            <div class="admin-section">
                <h3>Aggiungi/Modifica Opera</h3>
                <p class="warning">Max 8MB per immagine</p>
                <form id="gallery-form">
                    <input type="text" id="gallery-title" placeholder="Titolo" required>
                    <input type="text" id="gallery-desc" placeholder="Descrizione" required>
                    <input type="text" id="gallery-dimensions" placeholder="Dimensioni" required>
                    <input type="number" id="gallery-price" placeholder="Prezzo (€)" min="1" required>
                    <input type="file" id="gallery-image-file" accept="image/*" required>
                    <img id="preview-main" class="preview-img" alt="Anteprima">
                    <input type="file" id="gallery-rendering-file" accept="image/*">
                    <img id="preview-rendering" class="preview-img" alt="Anteprima rendering">
                    <button type="submit" id="gallery-submit-btn">Aggiungi Opera</button>
                    <button type="button" onclick="cancelEdit()" id="cancel-edit" style="display:none;background:#e74c3c;">Annulla</button>
                    <div id="gallery-feedback"></div>
                </form>
            </div>
            <!-- GITHUB -->
            <div class="admin-section">
                <h3>Sincronizzazione GitHub</h3>
                <p class="github-sync">Dati caricati da GitHub: <span id="github-status">In attesa...</span></p>
                <button onclick="exportData()" style="background:#27ae60;">Esporta Dati (JSON)</button>
                <button onclick="pushToGitHub()" style="background:#6f42c1;margin-left:10px;">Push Automatico su GitHub</button>
                <p><small>Repo: <code>viamoarte/Sito-viamo</code> → <code>data.json</code></small></p>
                <div id="github-feedback"></div>
            </div>
            <!-- IMPORT JSON -->
            <div class="admin-section">
                <h3>Ripristino da Backup</h3>
                <p>Carica un file <code>data.json</code> per ripristinare tutto</p>
                <input type="file" id="import-json-file" accept=".json,application/json">
                <button onclick="importFromJson()" style="background:#e67e22;margin-top:10px;">Importa e Ripristina Tutto</button>
                <div id="import-feedback"></div>
            </div>
            <!-- PASSWORD -->
            <div class="password-change">
                <h3>Cambia Password Admin</h3>
                <form id="password-form">
                    <input type="password" id="old-password" placeholder="Password attuale" required>
                    <input type="password" id="new-password" placeholder="Nuova password (min 10)" required minlength="10">
                    <input type="password" id="confirm-password" placeholder="Conferma" required>
                    <button type="submit">Cambia</button>
                    <div id="password-feedback"></div>
                </form>
            </div>
        </div>
    </section>
    <footer>© 2025 ViAmo Art. Tutti i diritti riservati.</footer>
    <script>
        // CONFIG
        const SERVICE_ID = 'service_rdfzdc8';
        const TEMPLATE_TO_ADMIN = 'template_pxpn0pv';
        const TEMPLATE_AUTOREPLY = 'template_07bn298';
        const GITHUB_DATA_URL = 'https://raw.githubusercontent.com/viamoarte/Sito-viamo/main/data.json';
        const GITHUB_API = 'https://api.github.com/repos/viamoarte/Sito-viamo/contents/data.json';
        // DATI
        let artworks = [], homeText = '', aboutText = '', bannerData = '';
        let adminPasswordHash = '';
        let loggedIn = false, editingId = null;

        // HASH SHA-256
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // PASSWORD DEFAULT #Viamo2025
        (async () => {
            const defaultHash = await hashPassword('#Viamo2025');
            const savedHash = localStorage.getItem('adminPasswordHash');
            if (!savedHash || savedHash === 'undefined' || savedHash === 'null' || savedHash === '') {
                localStorage.setItem('adminPasswordHash', defaultHash);
            }
            adminPasswordHash = localStorage.getItem('adminPasswordHash');
        })();

        // ANTI-DEFACEMENT
        setInterval(() => {
            if ((localStorage.getItem('artworks') === '[]' || !localStorage.getItem('artworks')) && artworks.length > 0) {
                console.warn("Tentativo di cancellazione dati!");
                localStorage.clear();
                location.reload();
            }
        }, 8000);

        // CARICAMENTO DATI CON PRIORITÀ LOCALE
        function loadData() {
            artworks = JSON.parse(localStorage.getItem('artworks') || '[]');
            homeText = localStorage.getItem('homeText') || 'ViAmo, alias Vincenza Amodio, è un\'artista che trasforma emozioni in opere d\'arte unendo street art e cultura pop.';
            aboutText = localStorage.getItem('aboutText') || 'Vincenza Amodio, nota come ViAmo, è un\'artista italiana che fonde street art e pop culture con uno stile unico e vibrante.';
            bannerData = localStorage.getItem('bannerData') || 'Opere/banner.jpg'; // PRIORITÀ A LOCALE
        }

        async function loadFromGitHub(force = false) {
            try {
                const res = await fetch(GITHUB_DATA_URL + '?t=' + Date.now());
                if (!res.ok) throw new Error('Non trovato');
                const data = await res.json();
                if (force || !localStorage.getItem('artworks')) {
                    artworks = data.artworks || [];
                    homeText = data.homeText || homeText;
                    aboutText = data.aboutText || aboutText;
                    // NON TOCCARE bannerData se esiste in localStorage
                    if (!localStorage.getItem('bannerData')) {
                        bannerData = data.bannerData || 'Opere/banner.jpg';
                    }
                    localStorage.setItem('artworks', JSON.stringify(artworks));
                    localStorage.setItem('homeText', homeText);
                    localStorage.setItem('aboutText', aboutText);
                    if (!localStorage.getItem('bannerData')) {
                        localStorage.setItem('bannerData', bannerData);
                    }
                }
                document.getElementById('github-status').textContent = 'SÌ';
                document.getElementById('github-status').style.color = 'green';
            } catch (err) {
                document.getElementById('github-status').textContent = 'NO';
                document.getElementById('github-status').style.color = 'red';
            }
        }

        function forceSyncFromGitHub() {
            if (confirm("Sincronizzare ORA da GitHub? (sovrascrive tutto)")) {
                ['artworks','homeText','aboutText','bannerData'].forEach(k => localStorage.removeItem(k));
                loadFromGitHub(true).then(() => location.reload());
            }
        }

        // CARICA SEMPRE PRIMA I DATI LOCALI
        loadData();
        renderAll(); // Renderizza subito con dati locali
        loadFromGitHub(); // Poi prova GitHub (non sovrascrive banner)

        function renderAll() {
            document.getElementById('home-text').textContent = homeText;
            document.getElementById('about-text').textContent = aboutText;
            document.getElementById('banner').src = bannerData; // Usa sempre bannerData corrente
            renderGallery();
        }

        function showFeedback(id, msg, ok = true) {
            const el = document.getElementById(id);
            el.innerHTML = `<div class="feedback ${ok ? 'success' : 'error'}">${msg}</div>`;
            setTimeout(() => el.innerHTML = '', 5000);
        }
        function toggleAdmin() {
            const admin = document.getElementById('admin');
            admin.style.display = admin.style.display === 'block' ? 'none' : 'block';
        }
        function logout() {
            loggedIn = false; editingId = null;
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('admin-panel').style.display = 'none';
            renderGallery();
        }
        function renderGallery() {
            const c = document.getElementById('gallery-container');
            c.innerHTML = artworks.map(a => `
                <div class="artwork">
                    <img src="${a.image}" alt="${a.title}" loading="lazy">
                    <h3>${a.title}</h3>
                    <p>Dimensioni: ${a.dimensions}</p>
                    <p>Prezzo: €${a.price}</p>
                    <a href="artwork.html?id=${a.id}">Dettagli</a>
                    ${loggedIn ? `<button onclick="startEdit(${a.id})">Modifica</button>
                                 <button onclick="deleteArtwork(${a.id})" style="background:#e74c3c;">Elimina</button>` : ''}
                </div>
            `).join('');
        }

        // COMPRESSIONE IMMAGINI (banner più aggressiva)
        function compressImage(file, callback, quality = 0.8) {
            if (file.size < 800000) return callback(URL.createObjectURL(file));
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const max = 1400;
                let width = img.width;
                let height = img.height;
                if (width > max) {
                    height = height * (max / width);
                    width = max;
                }
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                callback(canvas.toDataURL('image/webp', quality));
            };
            img.src = URL.createObjectURL(file);
        }

        function previewFile(inputId, previewId) {
            const file = document.getElementById(inputId).files[0];
            const preview = document.getElementById(previewId);
            if (file) {
                if (file.size > 8 * 1024 * 1024) {
                    showFeedback('gallery-feedback', 'File troppo grande! Max 8MB', false);
                    return;
                }
                const reader = new FileReader();
                reader.onload = e => { preview.src = e.target.result; preview.style.display = 'block'; };
                reader.readAsDataURL(file);
            }
        }

        // EVENTI
        document.getElementById('banner-file').addEventListener('change', () => previewFile('banner-file', 'banner-preview'));
        document.getElementById('gallery-image-file').addEventListener('change', () => previewFile('gallery-image-file', 'preview-main'));
        document.getElementById('gallery-rendering-file').addEventListener('change', () => previewFile('gallery-rendering-file', 'preview-rendering'));

        // BANNER ORA FUNZIONA AL 100%
        document.getElementById('banner-form').addEventListener('submit', e => {
            e.preventDefault();
            const file = document.getElementById('banner-file').files[0];
            if (!file) return showFeedback('banner-feedback', 'Seleziona un file!', false);
            if (file.size > 8 * 1024 * 1024) return showFeedback('banner-feedback', 'Max 8MB!', false);
            
            compressImage(file, dataUrl => {
                bannerData = dataUrl;
                localStorage.setItem('bannerData', bannerData); // Salvataggio forzato
                document.getElementById('banner').src = bannerData;
                showFeedback('banner-feedback', 'Banner salvato permanentemente!');
            }, 0.75); // Qualità ridotta per sicurezza localStorage
        });

        // ... tutto il resto identico (testi, gallery, login, ecc.) ...

        ['home', 'about'].forEach(s => {
            document.getElementById(s + '-form').addEventListener('submit', e => {
                e.preventDefault();
                const text = document.getElementById('new-' + s + '-text').value.trim();
                if (!text) return;
                if (s === 'home') homeText = text;
                if (s === 'about') aboutText = text;
                localStorage.setItem(s + 'Text', text);
                document.getElementById(s + '-text').textContent = text;
                showFeedback(s + '-feedback', 'Aggiornato!');
            });
        });

        // LOGIN
        document.getElementById('login-form').addEventListener('submit', async e => {
            e.preventDefault();
            const input = document.getElementById('admin-password').value;
            const inputHash = await hashPassword(input);
            if (inputHash === adminPasswordHash) {
                loggedIn = true;
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                document.getElementById('login-error').style.display = 'none';
                document.getElementById('new-home-text').value = homeText;
                document.getElementById('new-about-text').value = aboutText;
                renderGallery();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        });

        // ... resto del codice identico fino alla fine ...

        renderGallery();
    </script>
</body>
</html>
