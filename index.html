<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ViAmo - Galleria d'Arte</title>

    <!-- Google Drive API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        (function(){ emailjs.init("z2kCGkszIchfP51G_"); })();
    </script>

    <style>
        body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f0f0f0;}
        header{background:#2c3e50;color:#fff;padding:15px;text-align:center;}
        #banner{width:100%;max-height:350px;object-fit:cover;}
        nav{background:#34495e;padding:10px;text-align:center;}
        nav a{color:#fff;margin:0 15px;text-decoration:none;font-size:1.1em;}
        nav a:hover{text-decoration:underline;}
        section{padding:25px;margin:20px;background:#fff;border-radius:10px;box-shadow:0 0 15px rgba(0,0,0,.1);}
        .gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;}
        .artwork{border:1px solid #ddd;padding:15px;text-align:center;background:#fff;border-radius:8px;}
        .artwork img{width:100%;height:200px;object-fit:cover;border-radius:5px;}
        form{display:flex;flex-direction:column;max-width:450px;margin:0 auto;}
        input,textarea{margin:10px 0;padding:12px;border:1px solid #ccc;border-radius:5px;font-size:1em;}
        input[type=file]{margin:10px 0;padding:8px;}
        button{background:#2c3e50;color:#fff;border:none;padding:12px;border-radius:5px;cursor:pointer;font-size:1em;}
        button:hover{background:#34495e;}
        button:disabled{background:#95a5a6;color:#7f8c8d;}
        #admin{display:none;}
        .feedback{padding:10px;border-radius:5px;margin:10px 0;text-align:center;}
        .feedback.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb;}
        .feedback.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;}
        .preview-img{max-width:100%;max-height:150px;margin:10px 0;border-radius:5px;display:none;}
        .admin-section{margin-bottom:30px;}
        .admin-section h3{margin-top:0;}
        .backup-section button{margin:5px;}
        .google-auth{margin:10px 0;text-align:center;}
        .google-auth button{background:#4285F4;color:#fff;}
    </style>
</head>
<body>
    <header>
        <img id="banner" src="Opere/banner.jpg" alt="Banner ViAmo" loading="lazy">
        <h1>ViAmo - Vincenza Amodio</h1>
    </header>

    <nav>
        <a href="#home">Home</a>
        <a href="#gallery">Galleria</a>
        <a href="#about">Chi Sono</a>
        <a href="#contact">Contatti</a>
        <a href="#" onclick="toggleAdmin()">Area Riservata</a>
    </nav>

    <section id="home"><h2>Home</h2><p id="home-text">Caricamento...</p></section>
    <section id="gallery"><h2>Galleria Opere</h2><div class="gallery" id="gallery-container"></div></section>
    <section id="about"><h2>Chi è ViAmo</h2><p id="about-text">Caricamento...</p></section>

    <section id="contact">
        <h2>Contattami</h2>
        <form id="contact-form">
            <input type="text" name="user_name" placeholder="Il tuo nome" required>
            <input type="email" name="user_email" placeholder="La tua email" required>
            <textarea name="message" placeholder="Il tuo messaggio" rows="5" required></textarea>
            <button type="submit">Invia Messaggio</button>
            <div id="form-feedback"></div>
        </form>
    </section>

    <!-- ADMIN -->
    <section id="admin">
        <h2>Area Amministratore</h2>
        <div id="login-section">
            <input type="password" id="admin-password" placeholder="Password" required>
            <button onclick="login()">Accedi</button>
            <div id="login-error" style="color:red;display:none;">Password errata</div>
        </div>

        <div id="admin-panel" style="display:none;">
            <button onclick="logout()">Esci</button>

            <!-- BANNER -->
            <div class="admin-section">
                <h3>Banner</h3>
                <input type="file" id="banner-file" accept="image/*">
                <img id="banner-preview" class="preview-img" alt="Anteprima">
                <button onclick="updateBanner()">Aggiorna</button>
            </div>

            <!-- TESTI -->
            <div class="admin-section">
                <h3>Testo Home</h3>
                <textarea id="new-home-text" rows="4"></textarea>
                <button onclick="updateText('home')">Aggiorna</button>
            </div>
            <div class="admin-section">
                <h3>Testo Chi Sono</h3>
                <textarea id="new-about-text" rows="4"></textarea>
                <button onclick="updateText('about')">Aggiorna</button>
            </div>

            <!-- OPERE -->
            <div class="admin-section">
                <h3>Aggiungi Opera</h3>
                <input type="text" id="gallery-title" placeholder="Titolo" required>
                <input type="text" id="gallery-desc" placeholder="Descrizione" required>
                <input type="text" id="gallery-dimensions" placeholder="Dimensioni" required>
                <input type="number" id="gallery-price" placeholder="Prezzo (€)" min="1" required>
                <input type="file" id="gallery-image-file" accept="image/*" required>
                <img id="preview-main" class="preview-img" alt="Anteprima">
                <input type="file" id="gallery-rendering-file" accept="image/*">
                <img id="preview-rendering" class="preview-img" alt="Anteprima rendering">
                <button onclick="addArtwork()">Aggiungi</button>
                <div id="gallery-feedback"></div>
            </div>

            <!-- GOOGLE DRIVE -->
            <div class="admin-section">
                <h3>Google Drive</h3>
                <div class="google-auth">
                    <button id="auth-btn" onclick="handleAuth()">Accedi con Google</button>
                    <button id="upload-btn" onclick="uploadToDrive()" style="display:none;">Carica Immagini su Drive</button>
                </div>
                <div id="drive-feedback"></div>
            </div>

            <!-- BACKUP JSON -->
            <div class="admin-section backup-section">
                <h3>Backup Dati</h3>
                <button onclick="exportJSON()" style="background:#27ae60;">Esporta JSON</button>
                <input type="file" id="import-file" accept=".json" style="margin:10px 0;">
                <button onclick="importJSON()" style="background:#2980b9;">Importa JSON</button>
                <div id="backup-feedback"></div>
            </div>
        </div>
    </section>

    <script>
        // DATI
        let artworks = JSON.parse(localStorage.getItem('artworks')) || [];
        let homeText = localStorage.getItem('homeText') || 'Benvenuti nel mio mondo artistico.';
        let aboutText = localStorage.getItem('aboutText') || 'Sono ViAmo, artista di street art.';
        let bannerData = localStorage.getItem('bannerData') || 'Opere/banner.jpg';
        const ADMIN_PASS = '#Venus2025';
        let loggedIn = false;

        // INIZIO
        document.getElementById('home-text').textContent = homeText;
        document.getElementById('about-text').textContent = aboutText;
        document.getElementById('banner').src = bannerData;
        renderGallery();

        function renderGallery() {
            const container = document.getElementById('gallery-container');
            container.innerHTML = artworks.map(a => `
                <div class="artwork">
                    <img src="${a.image}" alt="${a.title}" loading="lazy">
                    <h3>${a.title}</h3>
                    <p>${a.dimensions}</p>
                    <p>€${a.price}</p>
                    <a href="artwork.html?id=${a.id}">Dettagli</a>
                    ${loggedIn ? `<button onclick="editArtwork(${a.id})">Modifica</button>
                                 <button onclick="deleteArtwork(${a.id})" style="background:#e74c3c;">Elimina</button>` : ''}
                </div>
            `).join('');
        }

        function toggleAdmin() {
            document.getElementById('admin').style.display = 
                document.getElementById('admin').style.display === 'block' ? 'none' : 'block';
        }

        function login() {
            const pass = document.getElementById('admin-password').value;
            if (pass === ADMIN_PASS) {
                loggedIn = true;
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                document.getElementById('new-home-text').value = homeText;
                document.getElementById('new-about-text').value = aboutText;
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        function logout() {
            loggedIn = false;
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('admin-password').value = '';
            document.getElementById('login-error').style.display = 'none';
        }

        function updateBanner() {
            const file = document.getElementById('banner-file').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                bannerData = e.target.result;
                document.getElementById('banner').src = bannerData;
                localStorage.setItem('bannerData', bannerData);
            };
            reader.readAsDataURL(file);
        }

        function updateText(section) {
            const text = document.getElementById(`new-${section}-text`).value.trim();
            if (!text) return;
            if (section === 'home') homeText = text;
            if (section === 'about') aboutText = text;
            localStorage.setItem(`${section}Text`, text);
            document.getElementById(`${section}-text`).textContent = text;
        }

        // ANTEPRIMA
        document.getElementById('gallery-image-file').addEventListener('change', () => preview('gallery-image-file', 'preview-main'));
        document.getElementById('gallery-rendering-file').addEventListener('change', () => preview('gallery-rendering-file', 'preview-rendering'));

        function preview(inputId, previewId) {
            const file = document.getElementById(inputId).files[0];
            const img = document.getElementById(previewId);
            if (file) {
                const reader = new FileReader();
                reader.onload = e => { img.src = e.target.result; img.style.display = 'block'; };
                reader.readAsDataURL(file);
            }
        }

        function addArtwork() {
            const title = document.getElementById('gallery-title').value.trim();
            const desc = document.getElementById('gallery-desc').value.trim();
            const dimensions = document.getElementById('gallery-dimensions').value.trim();
            const price = parseInt(document.getElementById('gallery-price').value);
            const imageFile = document.getElementById('gallery-image-file').files[0];
            const renderingFile = document.getElementById('gallery-rendering-file').files[0];

            if (!title || !desc || !dimensions || isNaN(price) || !imageFile) {
                showFeedback('gallery-feedback', 'Compila tutti i campi!', false);
                return;
            }

            const reader = new FileReader();
            reader.onload = e => {
                const image = e.target.result;
                let rendering = null;
                if (renderingFile) {
                    const reader2 = new FileReader();
                    reader2.onload = e2 => {
                        rendering = e2.target.result;
                        finalize();
                    };
                    reader2.readAsDataURL(renderingFile);
                } else {
                    finalize();
                }

                function finalize() {
                    const id = Date.now();
                    artworks.push({ id, title, desc, dimensions, price, image, rendering });
                    localStorage.setItem('artworks', JSON.stringify(artworks));
                    renderGallery();
                    document.getElementById('gallery-form').reset();
                    document.querySelectorAll('.preview-img').forEach(img => img.style.display = 'none');
                    showFeedback('gallery-feedback', 'Opera aggiunta!');
                }
            };
            reader.readAsDataURL(imageFile);
        }

        // GOOGLE DRIVE
        const CLIENT_ID = 'INSERISCI_TUO_CLIENT_ID.apps.googleusercontent.com';
        const API_KEY = 'INSERISCI_TUA_API_KEY';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let tokenClient;
        let gapiInited = false, gisInited = false;

        function gapiLoad() {
            gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [DISCOVERY_DOC],
                });
                gapiInited = true;
                maybeEnableButtons();
            });
        }

        function gisLoad() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (resp) => {
                    if (resp.error) throw resp;
                    document.getElementById('auth-btn').style.display = 'none';
                    document.getElementById('upload-btn').style.display = 'inline-block';
                },
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('auth-btn').disabled = false;
            }
        }

        function handleAuth() {
            tokenClient.callback = async (resp) => {
                if (resp.error) throw resp;
                document.getElementById('auth-btn').style.display = 'none';
                document.getElementById('upload-btn').style.display = 'inline-block';
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        async function uploadToDrive() {
            const btn = document.getElementById('upload-btn');
            btn.disabled = true;
            btn.textContent = 'Caricamento...';

            try {
                for (const art of artworks) {
                    if (art.image && !art.image.startsWith('https://')) {
                        const url = await uploadFile(art.image, `${art.id}_main.jpg`);
                        art.image = url;
                    }
                    if (art.rendering && !art.rendering.startsWith('https://')) {
                        const url = await uploadFile(art.rendering, `${art.id}_rendering.jpg`);
                        art.rendering = url;
                    }
                }
                localStorage.setItem('artworks', JSON.stringify(artworks));
                renderGallery();
                showFeedback('drive-feedback', 'Immagini caricate su Drive!');
            } catch (err) {
                showFeedback('drive-feedback', 'Errore upload', false);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Carica Immagini su Drive';
            }
        }

        async function uploadFile(base64, filename) {
            const blob = base64ToBlob(base64);
            const metadata = { name: filename, mimeType: blob.type };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', blob);

            const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                body: form
            });
            const file = await res.json();
            await gapi.client.drive.permissions.create({
                fileId: file.id,
                requestBody: { role: 'reader', type: 'anyone' }
            });
            return `https://drive.google.com/uc?id=${file.id}`;
        }

        function base64ToBlob(base64) {
            const [header, data] = base64.split(',');
            const mime = header.match(/:(.*?);/)[1];
            const binary = atob(data);
            const array = [];
            for (let i = 0; i < binary.length; i++) array.push(binary.charCodeAt(i));
            return new Blob([new Uint8Array(array)], { type: mime });
        }

        // ESPORTA / IMPORTERA JSON
        function exportJSON() {
            const data = { artworks, homeText, aboutText, bannerData };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'viamo-backup.json';
            a.click();
            showFeedback('backup-feedback', 'Dati esportati!');
        }

        function importJSON() {
            const file = document.getElementById('import-file').files[0];
            if (!file) return showFeedback('backup-feedback', 'Seleziona un file!', false);
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    artworks = data.artworks || [];
                    homeText = data.homeText || homeText;
                    aboutText = data.aboutText || aboutText;
                    bannerData = data.bannerData || bannerData;

                    localStorage.setItem('artworks', JSON.stringify(artworks));
                    localStorage.setItem('homeText', homeText);
                    localStorage.setItem('aboutText', aboutText);
                    localStorage.setItem('bannerData', bannerData);

                    location.reload();
                } catch {
                    showFeedback('backup-feedback', 'File non valido!', false);
                }
            };
            reader.readAsText(file);
        }

        // CONTATTO
        document.getElementById('contact-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const btn = this.querySelector('button');
            btn.disabled = true;
            btn.textContent = 'Invio...';

            const data = {
                user_name: this.user_name.value,
                user_email: this.user_email.value,
                message: this.message.value
            };

            emailjs.send('service_rdfzdc8', 'template_pxpn0pv', {
                to_email: 'viamoarte@gmail.com',
                ...data
            })
            .then(() => emailjs.send('service_rdfzdc8', 'template_07bn298', {
                to_email: data.user_email,
                user_name: data.user_name
            }))
            .then(() => {
                showFeedback('form-feedback', 'Inviato!');
                this.reset();
            })
            .catch(() => showFeedback('form-feedback', 'Errore', false))
            .finally(() => {
                btn.disabled = false;
                btn.textContent = 'Invia Messaggio';
            });
        });

        function showFeedback(id, msg, ok = true) {
            const el = document.getElementById(id);
            el.innerHTML = `<div class="feedback ${ok ? 'success' : 'error'}">${msg}</div>`;
            setTimeout(() => el.innerHTML = '', 3000);
        }

        // CARICA GOOGLE API
        gapiLoad();
        gisLoad();
    </script>
</body>
</html>
